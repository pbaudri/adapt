# adapt_server — Serverpod Instructions

## Context7

Before any Serverpod implementation, fetch the latest documentation:

```
use context7 to get the latest docs for serverpod
```

This is critical because Serverpod evolves frequently. Always verify:
- YAML model syntax and supported field types
- Enum definition syntax in YAML
- Endpoint method signatures and session handling
- Authentication module API (`serverpod_auth`)
- Database query API (`session.db`)
- Migration commands

## Models

All models are defined as YAML files in `lib/src/models/`.
After any model change, run: `melos run generate`

### Enums — one file per enum

All fields with predefined values **must** use a Serverpod enum — never a raw `String`.
Each enum is a separate YAML file in `lib/src/models/`.

```
lib/src/models/
├── enums/
│   ├── biological_sex.yaml
│   ├── user_goal.yaml
│   ├── eating_style.yaml
│   ├── alcohol_habit.yaml
│   ├── weight_unit.yaml
│   ├── height_unit.yaml
│   ├── meal_type.yaml
│   ├── input_method.yaml
│   ├── meal_source.yaml
│   └── drink_type.yaml
├── user_profile.yaml
├── meal_log.yaml
├── meal_result.yaml
├── meal_correction_input.yaml
├── drink_log.yaml
├── drink_reference.yaml
├── daily_summary.yaml
├── morning_recap.yaml
├── home_data.yaml
└── day_detail.yaml
```

Enum YAML syntax:

```yaml
# biological_sex.yaml
enum: BiologicalSex
values:
  - male
  - female

# user_goal.yaml
enum: UserGoal
values:
  - loseWeight
  - eatBetter
  - stayAware

# eating_style.yaml
enum: EatingStyle
values:
  - homeCooked
  - takeaway
  - restaurants
  - mixed

# alcohol_habit.yaml
enum: AlcoholHabit
values:
  - rarely
  - sometimes
  - often

# weight_unit.yaml
enum: WeightUnit
values:
  - kg
  - lbs

# height_unit.yaml
enum: HeightUnit
values:
  - cm
  - ft

# meal_type.yaml
enum: MealType
values:
  - breakfast
  - lunch
  - dinner
  - snack

# input_method.yaml
enum: InputMethod
values:
  - photo
  - text
  - location

# meal_source.yaml
enum: MealSource
values:
  - aiEstimated
  - database
  - userCorrected

# drink_type.yaml
enum: DrinkType
values:
  - beer
  - wine
  - champagne
  - cocktail
  - whisky
  - longDrink
  - hardSeltzer
  - other
```

### Class models

```yaml
# user_profile.yaml
class: UserProfile
fields:
  userId:          int
  age:             int?
  biologicalSex:   BiologicalSex?
  weightKg:        double?
  heightCm:        double?
  weightUnit:      WeightUnit
  heightUnit:      HeightUnit
  goal:            UserGoal
  eatingStyle:     EatingStyle
  alcoholHabit:    AlcoholHabit
  alcoholTracking: bool
  morningRecap:    bool
  updatedAt:       DateTime

# meal_log.yaml
class: MealLog
fields:
  userId:       int
  loggedAt:     DateTime
  mealType:     MealType
  inputMethod:  InputMethod
  rawInput:     String?
  imageUrl:     String?
  locationName: String?
  estimated:    bool

# meal_result.yaml
class: MealResult
fields:
  mealLogId:   int
  name:        String
  caloriesKcal: int
  proteinG:    double
  carbsG:      double
  fatG:        double
  aiMessage:   String
  aiTip:       String?
  source:      MealSource

# drink_log.yaml
class: DrinkLog
fields:
  userId:      int
  loggedAt:    DateTime
  drinkType:   DrinkType
  quantity:    int
  caloriesKcal: int
```

**Never edit any file in `adapt_client/`** — it is fully regenerated by `melos run generate`.

## Endpoints

One file per endpoint in `lib/src/endpoints/`.
Endpoints orchestrate services — they never access the database directly.

```
lib/src/endpoints/
├── auth_endpoint.dart
├── onboarding_endpoint.dart
├── home_endpoint.dart
├── meal_endpoint.dart
├── drink_endpoint.dart
├── history_endpoint.dart
├── profile_endpoint.dart
└── recap_endpoint.dart
```

Correct endpoint pattern:

```dart
class MealEndpoint extends Endpoint {
  Future<MealResult> logMealByText(Session session, String text) async {
    return MealService.analyzeText(session, text);
  }
}
```

Fetch the latest endpoint syntax via Context7 before implementing new endpoints.

## Services

All business logic lives in `lib/src/services/`. Never put logic in endpoints.

```
lib/src/services/
├── ai_service.dart              # All AI calls (GPT-4o) — text and photo analysis
├── nutrition_service.dart       # Calorie calculations
├── recap_service.dart           # Morning recap generation
└── daily_summary_service.dart   # Summary aggregation and updates
```

## Calorie Calculation

**Only** `nutrition_service.dart` calculates calories. Never inline this formula elsewhere.

```dart
// In nutrition_service.dart — single source of truth
static int calculateCalories({
  required double proteinG,
  required double carbsG,
  required double fatG,
}) {
  return ((proteinG * 4) + (carbsG * 4) + (fatG * 9)).round();
}
```

This is called automatically after `correctMeal()` — `caloriesKcal` is never accepted as input.

## MealCorrectionInput

```dart
// CORRECT — calories excluded, always recalculated
class MealCorrectionInput {
  String? name;
  double? proteinG;
  double? carbsG;
  double? fatG;
  // caloriesKcal → NEVER here
}
```

## drink_reference

Seed data only. Populated once at server startup via a migration.
Never modified at runtime.

```dart
// calories_kcal in drink_logs is always pre-calculated at log time:
final calories = quantity * drinkReference.caloriesPerUnit;
```

## Database

Use Serverpod ORM via `session.db`. Fetch latest query syntax via Context7.

```dart
// Correct pattern — via session.db
final profile = await UserProfile.db.findFirstRow(
  session,
  where: (t) => t.userId.equals(session.authenticated!.userId),
);
```

## AI Service

`ai_service.dart` sends prompts to GPT-4o. It must always return a structured object:

```dart
// Expected AI response structure
{
  "name": "Big Mac Menu",
  "protein_g": 28,
  "carbs_g": 103,
  "fat_g": 44,
  "ai_message": "That's around 1,050 kcal. A light dinner tonight keeps your day balanced — no stress.",
  "ai_tip": "Try a soup or salad tonight — we'll show you options."
}
```

The AI prompt must enforce zero-judgment language. Never include words like "bad", "excess", "unhealthy", or "too much" in any prompt or response template.

## Folder Structure

```
adapt_server/
├── lib/
│   ├── server.dart
│   └── src/
│       ├── endpoints/
│       ├── models/
│       │   ├── enums/           # One YAML file per enum
│       │   └── *.yaml           # Class model definitions
│       └── services/
├── migrations/
└── pubspec.yaml
```