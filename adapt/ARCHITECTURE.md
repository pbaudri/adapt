# ADAPT â€” Architecture Document

> **Start from real life.**
> Repository: https://github.com/pbaudri/adapt.git
> Stack: Flutter + Serverpod + Riverpod
> Architecture: Monorepo Melos + Clean Architecture
> Version: v1.0 â€” February 2026

---

## Table of Contents

1. [Project Overview](#1-project-overview)
2. [Monorepo Structure](#2-monorepo-structure)
3. [Database Schema](#3-database-schema)
4. [API Endpoints](#4-api-endpoints)
5. [Flutter Architecture](#5-flutter-architecture)
6. [Design System â€” adapt_theme](#6-design-system--adapt_theme)
7. [Packages](#7-packages)
8. [Key Architectural Decisions](#8-key-architectural-decisions)

---

## 1. Project Overview

Adapt is a zero-judgment nutrition tracking app designed for real life. It tracks meals, drinks, and provides adaptive daily recommendations without ever labelling food choices as good or bad.

### Core Principles

- **Zero judgment** â€” never uses words like "bad", "excess", or "cheat"
- **Real-time adaptation** â€” adjusts recommendations after each meal logged
- **Real life as the starting point** â€” fast food, alcohol, takeaway are first-class citizens

### Tagline

*"The nutrition app that starts from your real life, not an impossible ideal."*

---

## 2. Monorepo Structure

The project uses Melos to manage a Dart/Flutter monorepo. Serverpod generates three packages automatically at initialisation.

### Package Structure

| Package | Role | Owner |
|---|---|---|
| `adapt_server` | Backend â€” endpoints, models, services | Developer |
| `adapt_client` | Generated by Serverpod â€” **DO NOT EDIT** | Serverpod CLI |
| `adapt_flutter` | Flutter app â€” features, screens, providers | Developer |
| `adapt_theme` | Design system â€” theme, colors, shared widgets | Developer |

### melos.yaml

```yaml
name: adapt
repository: https://github.com/pbaudri/adapt.git

packages:
  - adapt_server
  - adapt_client
  - adapt_theme
  - adapt_flutter

command:
  bootstrap:
    hooks:
      post: melos run generate

scripts:
  generate:
    run: cd adapt_server && dart run serverpod_cli generate
    description: Generates Serverpod models + client

  build_runner:
    run: >
      melos exec --scope="adapt_flutter" --
      dart run build_runner build --delete-conflicting-outputs
    description: Generates Freezed + Riverpod code in adapt_flutter

  lint:
    run: melos exec -- flutter analyze

  test:
    run: melos exec -- flutter test

  clean:
    run: melos exec -- flutter clean
```

---

## 3. Database Schema

All data is stored in PostgreSQL via Serverpod. Units are always stored in SI (kg, cm) â€” unit preferences are display-only.

Fields with predefined values use **Serverpod enums** â€” never raw Strings. Each enum is defined as a separate YAML file in `adapt_server/lib/src/models/`.

### Enums

| Enum | Values |
|---|---|
| `BiologicalSex` | `male`, `female` |
| `UserGoal` | `loseWeight`, `eatBetter`, `stayAware` |
| `EatingStyle` | `homeCooked`, `takeaway`, `restaurants`, `mixed` |
| `AlcoholHabit` | `rarely`, `sometimes`, `often` |
| `WeightUnit` | `kg`, `lbs` |
| `HeightUnit` | `cm`, `ft` |
| `MealType` | `breakfast`, `lunch`, `dinner`, `snack` |
| `InputMethod` | `photo`, `text`, `location` |
| `MealSource` | `aiEstimated`, `database`, `userCorrected` |
| `DrinkType` | `beer`, `wine`, `champagne`, `cocktail`, `spirit`, `shooter`, `liqueur`, `longDrink`, `hardSeltzer`, `other` |

---

### users

| Column | Type / Notes |
|---|---|
| `id` | int â€” Primary Key |
| `name` | String |
| `email` | String? â€” nullable (guest mode) |
| `is_guest` | bool â€” default true |
| `created_at` | DateTime |

### user_profiles

| Column | Type / Notes |
|---|---|
| `id` | int â€” Primary Key |
| `user_id` | int â€” FK â†’ users |
| `age` | int? |
| `biological_sex` | `BiologicalSex?` |
| `weight_kg` | double? â€” always stored in kg |
| `height_cm` | double? â€” always stored in cm |
| `weight_unit` | `WeightUnit` â€” display preference only |
| `height_unit` | `HeightUnit` â€” display preference only |
| `goal` | `UserGoal` |
| `eating_style` | `EatingStyle` |
| `alcohol_habit` | `AlcoholHabit` |
| `alcohol_tracking` | bool â€” default true |
| `morning_recap` | bool â€” default true |
| `updated_at` | DateTime |

### meal_logs

| Column | Type / Notes |
|---|---|
| `id` | int â€” Primary Key |
| `user_id` | int â€” FK â†’ users |
| `logged_at` | DateTime |
| `meal_type` | `MealType` |
| `input_method` | `InputMethod` |
| `raw_input` | String? â€” text entered or photo prompt |
| `image_url` | String? â€” if photo |
| `location_name` | String? â€” e.g. McDonald's |
| `estimated` | bool â€” default true |

### meal_results

| Column | Type / Notes |
|---|---|
| `id` | int â€” Primary Key |
| `meal_log_id` | int â€” FK â†’ meal_logs (unique) |
| `name` | String â€” AI-normalised name e.g. "Big Mac Menu" |
| `calories_kcal` | int â€” auto-calculated: `(pÃ—4)+(cÃ—4)+(fÃ—9)` |
| `protein_g` | double |
| `carbs_g` | double |
| `fat_g` | double |
| `ai_message` | String â€” zero-judgment message |
| `ai_tip` | String? â€” optional suggestion |
| `source` | `MealSource` |
| `emojis` | String â€” JSON array e.g. `["ğŸ","ğŸ¥—"]` â€” AI generated, 1 to 3 emojis |

### drink_logs

| Column | Type / Notes |
|---|---|
| `id` | int â€” Primary Key |
| `user_id` | int â€” FK â†’ users |
| `logged_at` | DateTime |
| `drink_type` | `DrinkType` |
| `quantity` | int â€” number of glasses |
| `calories_kcal` | int â€” denormalised: `quantity Ã— ref calories` |

### drink_reference

| `drink_type` | `calories_per_unit` | `serving_description` |
|---|---|---|
| `beer` | 150 kcal | 33cl |
| `wine` | 120 kcal | 15cl |
| `champagne` | 90 kcal | 12cl |
| `cocktail` | 180 kcal | 20cl |
| `spirit` | 65 kcal | 4cl |
| `shooter` | 50 kcal | 3cl |
| `liqueur` | 100 kcal | 4cl |
| `long_drink` | 150 kcal | 25cl |
| `hard_seltzer` | 90 kcal | 33cl |
| `other` | 120 kcal | â€” |
| `sort_order` | int â€” display order |

### daily_summaries

| Column | Type / Notes |
|---|---|
| `id` | int â€” Primary Key |
| `user_id` | int â€” FK â†’ users |
| `date` | DateTime â€” date only, no time |
| `total_kcal` | int |
| `total_protein_g` | double |
| `total_carbs_g` | double |
| `total_fat_g` | double |
| `had_alcohol` | bool |
| `meal_emojis` | String â€” JSON array, max 6 emojis, deduplicated, includes meal + drink emojis |
| `morning_recap_sent` | bool â€” default false |

### morning_recaps

| Column | Type / Notes |
|---|---|
| `id` | int â€” Primary Key |
| `user_id` | int â€” FK â†’ users |
| `date` | DateTime |
| `headline` | String â€” e.g. "Morning, Pierre." |
| `sub_message` | String |
| `tips` | JSON â€” `List<{icon, title, subtitle}>` |
| `seen_at` | DateTime? â€” null until user opens recap |

---

## 4. API Endpoints

All endpoints are defined in `adapt_server` and consumed via the generated `adapt_client` package.

### AuthEndpoint

| Method | Returns |
|---|---|
| `signInWithEmail(email, password)` | `AuthToken` |
| `signUpWithEmail(email, password)` | `AuthToken` |
| `continueAsGuest()` | `AuthToken` |

### OnboardingEndpoint

| Method | Returns |
|---|---|
| `saveName(name)` | `void` |
| `saveEatingStyle(style)` | `void` |
| `saveGoal(goal)` | `void` |
| `saveAlcoholHabit(habit)` | `void` |
| `savePersonalInfo(age, sex, weightKg, heightCm)` | `void` |

### HomeEndpoint

| Method | Returns |
|---|---|
| `getHomeData()` | `HomeData` |

> Aggregates: greeting, daily kcal, adaptive message, last meals logged.

### MealEndpoint

| Method | Returns |
|---|---|
| `logMealByText(text)` | `MealResult` |
| `logMealByPhoto(imageBytes)` | `MealResult` |
| `confirmMeal(mealLogId)` | `DailySummary` |
| `correctMeal(mealLogId, correctedData)` | `MealResult` |
| `getTodayMeals()` | `List<MealLog>` |

> `MealCorrectionInput: { name?, proteinG?, carbsG?, fatG? }`
> `caloriesKcal` is excluded â€” always auto-calculated server-side.

### DrinkEndpoint

| Method | Returns |
|---|---|
| `getDrinkReference()` | `List<DrinkReference>` â€” ordered by sort_order ASC |
| `logDrinks(drinkType, quantity)` | `DailySummary` |
| `getTodayDrinks()` | `List<DrinkLog>` |

### HistoryEndpoint

| Method | Returns |
|---|---|
| `getWeekSummary(weekStartDate)` | `List<DailySummary>` |
| `getDayDetail(date)` | `DayDetail` |

> `DayDetail = DailySummary + List<MealLog> + List<DrinkLog>`

### ProfileEndpoint

| Method | Returns |
|---|---|
| `getProfile()` | `UserProfile` |
| `updateWeight(weightKg)` | `UserProfile` |
| `updateHeight(heightCm)` | `UserProfile` |
| `updateAge(age)` | `UserProfile` |
| `updateGoal(goal)` | `UserProfile` |
| `updateWeightUnit(unit)` | `UserProfile` |
| `updateHeightUnit(unit)` | `UserProfile` |
| `updatePreferences(alcoholTracking, morningRecap)` | `UserProfile` |
| `deleteAllData()` | `void` |

### RecapEndpoint

| Method | Returns |
|---|---|
| `getMorningRecap()` | `MorningRecap?` |
| `markRecapSeen(recapId)` | `void` |

---

## 5. Flutter Architecture

`adapt_flutter` follows Clean Architecture with a feature-first folder structure. Each feature is fully self-contained.

### Feature Structure

```
feature_name/
â”œâ”€â”€ data/
â”‚   â””â”€â”€ feature_repository.dart     # Calls adapt_client endpoints
â”œâ”€â”€ domain/
â”‚   â””â”€â”€ feature_state.dart          # Freezed state models
â””â”€â”€ presentation/
    â”œâ”€â”€ feature_screen.dart
    â”œâ”€â”€ widgets/                     # Feature-specific widgets
    â””â”€â”€ providers/
        â””â”€â”€ feature_provider.dart   # Riverpod providers
```

### Features

| Feature | Screens |
|---|---|
| `auth` | sign_in_screen, sign_up_screen |
| `onboarding` | name, eating_style, goal, alcohol, personal_info |
| `home` | home_screen |
| `meal_log` | photo_meal, describe_meal, meal_result, edit_meal |
| `drinks` | drinks_screen |
| `history` | history_screen |
| `profile` | profile_screen + bottom sheets |
| `morning_recap` | morning_recap_screen |

### Full Folder Structure

```
adapt_flutter/
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ main.dart
â”‚   â”œâ”€â”€ core/
â”‚   â”‚   â”œâ”€â”€ router/
â”‚   â”‚   â”‚   â”œâ”€â”€ app_router.dart
â”‚   â”‚   â”‚   â””â”€â”€ app_routes.dart
â”‚   â”‚   â””â”€â”€ utils/
â”‚   â”‚       â”œâ”€â”€ unit_converter.dart     # kgâ†”lbs, cmâ†”ft â€” only place for unit conversion
â”‚   â”‚       â””â”€â”€ date_formatter.dart
â”‚   â””â”€â”€ features/
â”‚       â”œâ”€â”€ auth/
â”‚       â”œâ”€â”€ onboarding/
â”‚       â”œâ”€â”€ home/
â”‚       â”œâ”€â”€ meal_log/
â”‚       â”œâ”€â”€ drinks/
â”‚       â”œâ”€â”€ history/
â”‚       â”œâ”€â”€ profile/
â”‚       â””â”€â”€ morning_recap/
â””â”€â”€ pubspec.yaml
```

---

## 6. Design System â€” adapt_theme

All visual components, colors, and typography live in `adapt_theme`. `adapt_flutter` imports this package and never defines its own colors or base styles.

```
adapt_theme/
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ adapt_theme.dart              # Barrel file â€” exports everything
â”‚   â”œâ”€â”€ theme/
â”‚   â”‚   â”œâ”€â”€ app_theme.dart
â”‚   â”‚   â”œâ”€â”€ app_colors.dart
â”‚   â”‚   â”œâ”€â”€ app_text_styles.dart
â”‚   â”‚   â””â”€â”€ app_dimensions.dart
â”‚   â””â”€â”€ widgets/
â”‚       â”œâ”€â”€ buttons/
â”‚       â”œâ”€â”€ inputs/
â”‚       â”œâ”€â”€ cards/
â”‚       â”œâ”€â”€ rows/
â”‚       â”œâ”€â”€ chips/
â”‚       â”œâ”€â”€ sheets/
â”‚       â”œâ”€â”€ navigation/
â”‚       â”œâ”€â”€ indicators/
â”‚       â”œâ”€â”€ layout/
â”‚       â””â”€â”€ media/
â””â”€â”€ pubspec.yaml
```

### Colors â€” AppColors

| Name | Hex | Usage |
|---|---|---|
| `background` | `#0A0A0F` | Screen backgrounds |
| `surface` | `#12121A` | Cards, inputs, nav bar |
| `surfaceElevated` | `#1C1C26` | Selected states, bottom sheets |
| `primary` | `#6C63FF` | CTA buttons, active states, borders |
| `primaryMuted` | `#4A4480` | Bar chart inactive bars |
| `textPrimary` | `#FFFFFF` | Main text |
| `textSecondary` | `#8A8A9A` | Subtitles, placeholders |
| `textMuted` | `#4A4A5A` | Divider labels, disabled |
| `protein` | `#5B9BD5` | Protein nutrient dot |
| `carbs` | `#4CAF7D` | Carbs nutrient dot |
| `fat` | `#F5A623` | Fat nutrient dot |
| `error` | `#E05252` | Destructive actions |
| `insightBorder` | `#6C63FF` | Left border on insight card |

### Typography â€” AppTextStyles

| Style | Size / Weight | Usage |
|---|---|---|
| `displayLarge` | 32px / W800 | Onboarding titles |
| `titleLarge` | 24px / W700 | Screen titles |
| `titleMedium` | 20px / W700 | Section headings |
| `bodyLarge` | 16px / W400 | Body text, buttons |
| `bodyMedium` | 14px / W400 | Subtitles, descriptions |
| `labelCaps` | 12px / W600 + letterSpacing | Section labels (TODAY, ABOUT YOU) |
| `displayValue` | 64px / W700 | Large value in bottom sheets (75 kg) |
| `displayValueUnit` | 24px / W400 | Unit next to display value |
| `textLinkPrimary` | 16px / W500 / primary | Sign in, sync links |
| `textLinkDestructive` | 16px / W500 / error | Delete my data |
| `textLinkMuted` | 14px / W400 / secondary | "Looks good actually", Cancel |

### Spacing & Radius â€” AppDimensions

| Token | Value | Usage |
|---|---|---|
| `spacing4/8/12/16/20/24/32/48` | 4â€“48px | All padding & gaps |
| `radiusSmall` | 12px | Small chips, toggles |
| `radiusMedium` | 16px | Cards, inputs |
| `radiusLarge` | 24px | Bottom sheets (top corners) |
| `radiusFull` | 999px | Buttons, pills, option rows |
| `buttonHeight` | 56px | All primary/secondary buttons |
| `screenPadding` | 24px horizontal | Screen edge padding |
| `cardPadding` | 16px all sides | Card internal padding |

### Widgets Inventory

#### Buttons

| Widget | Key Parameters |
|---|---|
| `AdaptPrimaryButton` | `label, onTap, isLoading, isDisabled, trailing: Widget?` |
| `AdaptSecondaryButton` | `label, onTap` |
| `AdaptSocialAuthButton` | `type: (apple \| google), onTap` |
| `AdaptTextLink` | `label, onTap, textStyle` |
| `AdaptActionButton` | `icon, label, textStyle, onTap` â€” Photo/Describe/Gallery buttons |

#### Inputs

| Widget | Key Parameters |
|---|---|
| `AdaptTextField` | `hint, controller, keyboardType, obscureText, trailing: Widget?` |
| `AdaptMultilineTextField` | `hint, controller` â€” minLines: 4, expandable |
| `AdaptEditableField` | `label, controller, onTap` â€” always-visible border + pencil icon |
| `AdaptUnitToggle` | `options: List<String>, selected, onChanged` â€” kg/lbs, cm/ft, Male/Female |
| `AdaptPasswordStrengthBar` | `strength: PasswordStrength` |

#### Cards & Rows

| Widget | Key Parameters |
|---|---|
| `AdaptSelectionCard` | `leading: Widget, title, description: String?, isSelected, onTap` |
| `AdaptOptionRow` | `leading: Widget, title, subtitle: String?, isSelected, onTap` |
| `AdaptInfoCard` | `child: Widget` â€” free content container |
| `AdaptInfoFormCard` | `children: List<Widget>` â€” rows separated by Dividers |
| `AdaptInsightCard` | `title, subtitle` â€” left purple border, ADAPT NOTICED label |
| `AdaptProfileRow` | `label, value, onTap` â€” with chevron |
| `AdaptNutritionRow` | `label, value, color, onChanged` â€” colored dot + editable underline |
| `AdaptPreferenceToggleRow` | `label, subtitle: String?, value, onChanged` |
| `AdaptAutoCalcCard` | Static hint â€” "calories update automatically" |
| `MealListItem` | `leading: Widget, name, calories, onTap` |
| `AdaptRecapTipItem` | `leading: Widget, backgroundColor, title, subtitle` |

#### Chips

| Widget | Key Parameters |
|---|---|
| `NutrientChip` | `label, value, color` â€” Protein 28g, Carbs 103g |
| `AdaptQuickAddChip` | `leading: Widget, label, onTap` |

#### Navigation & Layout

| Widget | Key Parameters |
|---|---|
| `AdaptBottomSheet` | `child: Widget, title: String?` |
| `AdaptBottomNavBar` | `currentIndex, onTap` |
| `AdaptBackButton` | `onTap?` â€” optional override of context.pop() |
| `AdaptPageHeader` | `title, subtitle` |
| `AdaptSectionTitle` | `label` â€” uppercase caps style |
| `AdaptStepIndicator` | `totalSteps, currentStep` â€” pill active, dot inactive |
| `AdaptLargeValueDisplay` | `value, unit` â€” "75 kg" in bottom sheets |
| `AdaptIconHero` | `child: Widget, size` â€” circular icon container |
| `AdaptDividerWithText` | `label` â€” "or" divider with lines |
| `AdaptQuantitySelector` | `value, label, onDecrement, onIncrement` |
| `AdaptWeekNavigator` | `label, onPrevious, onNext` |
| `AdaptBarChart` | `data: List<DayBarData>, selectedIndex` |
| `AdaptCameraPreview` | `imageFile?, label` |

---

## 7. Packages

| Package | Used in | Purpose |
|---|---|---|
| `riverpod` + `riverpod_annotation` | adapt_flutter | State management |
| `freezed` | adapt_flutter | Immutable models + sealed states |
| `go_router` | adapt_flutter | Navigation |
| `serverpod_client` | adapt_flutter | Generated server client |
| `sqflite` | adapt_flutter | Local cache |
| `image_picker` | adapt_flutter | Photo meal logging |
| `flutter_svg` | adapt_theme | SVG assets (auth icons, etc.) |
| `cached_network_image` | adapt_flutter | Server-side images |
| `permission_handler` | adapt_flutter | Camera + notifications |
| `flutter_local_notifications` | adapt_flutter | Morning recap push |
| `intl` | adapt_flutter | Date/number formatting |
| `flutter_dotenv` | adapt_flutter | Environment config |

---

## 8. Key Architectural Decisions

### Enums for predefined values
All fields with a fixed set of possible values use Serverpod enums defined as YAML files â€” never raw `String`. This enforces type safety at the Dart level and prevents invalid data from entering the database. Each enum lives in its own file in `adapt_server/lib/src/models/`.

### Units stored in SI
`weight_kg` and `height_cm` are always stored in kilograms and centimetres. `weight_unit` and `height_unit` are user display preferences only. Conversion is handled in `unit_converter.dart`, never in the database layer.

### Calories never user-editable
In `MealCorrectionInput`, `caloriesKcal` is excluded. Calories are always auto-calculated server-side:
```
calories = (protein_g Ã— 4) + (carbs_g Ã— 4) + (fat_g Ã— 9)
```
This prevents data inconsistencies and matches the UI hint *"calories update automatically"*.

### DailySummary denormalisation
`drink_logs.calories_kcal` stores the pre-calculated total (`quantity Ã— reference calories`). This avoids joining `drink_reference` on every history read and keeps queries fast.

### Guest mode first
Users can use the full app without an account. `is_guest: true` by default. Sign-in is optional and context-triggered (e.g. *"Sign in to sync your data"* in profile). This reduces onboarding friction significantly.

### AI name generation
`meal_results.name` is always AI-generated. The raw user input (text or photo) is sent to the AI service which returns a normalised name alongside nutritional estimates. This name is displayed as the meal title throughout the app.

### adapt_theme independence
`adapt_theme` has zero dependency on `adapt_flutter` or `adapt_server`. It exports a single barrel file `adapt_theme.dart` covering all widgets, colors, and styles. Any future package in the monorepo can import it.